name: Docker Build and Push

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker tag to use (e.g., latest, 1.4.0)'
        required: true
        default: 'latest'
  push:
    tags:
      - '*'

permissions:
  contents: read
  packages: write

jobs:
  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read project configuration
        id: project_config
        run: |
          source project.conf
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "owner=$OWNER" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine Docker tags
        id: docker_tags
        run: |
          VERSION="${{ steps.project_config.outputs.version }}"
          OWNER="${{ steps.project_config.outputs.owner }}"
          APP_NAME="${{ steps.project_config.outputs.app_name }}"

          # Default tags
          TAGS="${OWNER}/${APP_NAME}:latest"

          # If triggered by tag push
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG_NAME="${{ github.ref_name }}"
            TAGS="${TAGS},${OWNER}/${APP_NAME}:${TAG_NAME}"
            echo "Building from git tag: ${TAG_NAME}"
          # If manual workflow dispatch with custom tag
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            CUSTOM_TAG="${{ github.event.inputs.tag }}"
            if [[ "$CUSTOM_TAG" != "latest" ]]; then
              TAGS="${TAGS},${OWNER}/${APP_NAME}:${CUSTOM_TAG}"
            fi
            echo "Building with custom tag: ${CUSTOM_TAG}"
          # Default: use version from project.conf
          else
            TAGS="${TAGS},${OWNER}/${APP_NAME}:${VERSION}"
            echo "Building with version: ${VERSION}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "Docker tags: ${TAGS}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: ${{ steps.docker_tags.outputs.tags }}
          cache-from: type=registry,ref=${{ steps.project_config.outputs.owner }}/${{ steps.project_config.outputs.app_name }}:buildcache
          cache-to: type=registry,ref=${{ steps.project_config.outputs.owner }}/${{ steps.project_config.outputs.app_name }}:buildcache,mode=max

      - name: Docker push summary
        run: |
          echo "‚úÖ Docker image pushed successfully!"
          echo "üê≥ Tags: ${{ steps.docker_tags.outputs.tags }}"
          echo "üì¶ Platforms: linux/amd64, linux/arm64, linux/arm/v7"
          echo ""
          echo "Pull with:"
          echo "docker pull ${{ steps.project_config.outputs.owner }}/${{ steps.project_config.outputs.app_name }}:latest"
